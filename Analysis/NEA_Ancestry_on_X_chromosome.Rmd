---
title: "Script X chromosome Analysis"
output:
  html_document:
  keep_md: yes
pdf_document: default
---

  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Neandertal Ancestry on the X

## Functions

```{r eval=T,echo=F,results='hide'}
source("Analysis_R_functions.R")
```


## Cutoffs

```{r eval=T,echo=F,results='hide'}
chrom_ <- c("1" ,"2" , "3" , "4",  "5" , "6"  ,"7" , "8" , "9" , "10" ,"11", "12" ,"13","14" ,"15", "16" ,"17" ,"18", "19" , "20" ,"21", "22", "X" )

cluster_used = "population_cluster"


genetic_map = "Shared_Map"

min_len_present = 0.05
min_bp_len_present = 0
min_len_ancient = 0.2
min_bp_len_ancient = 0
min_SNP = 0
min_all_SNP = 0
penalty = 0.25
states = c("NEA")
called_type = as.vector(c("state"))
```

## Meta Data

```{r eval=T,echo=F,results='hide'}
############## change path  ##################
folder_path = "Paper_figures"

folder_path_data = "Paper_figures_Data/"

folder_path_Sup_Tables = "Supplements_Tables/"

path_to_dryad_downloaded_files = "Dryad_folder"

path_to_my_admixfrog_folder_ancient = "Admixfrog_res_ancient"

path_to_my_admixfrog_folder_present = "Admixfrog_res_present"
##############################################

Joint_Meta <- read.csv(paste0(path_to_dryad_downloaded_files,"Meta_Data_individuals.csv")) %>% 
  filter(sample_name != "Mota",superpopulation_cluster != "Africa") %>% mutate(sample_name=gsub( "-", ".", sample_name))

cluster_color_broad_all = data.frame(clusterF3D_broad_all = c("AncientEAS","ANE","ANS","EarlyOoA","EAS","North_Africa","postLGM-WEurHG","preLGM-WEurHG","SA","Sahul","Satsurblia","Siberia&Americas" ,"Sub-Sahara-Africa","SWA","WEur","Yamnaya"),
                                     cluster_color = 
                                       c("#009292FF","#FFCC00","#6DB6FFFF","#004949FF","#924900FF","#808080","#490092FF","#DB6D00FF","#920000FF","#006DDBFF","#FFB6DBFF","#24FF24FF","#000000FF","#B66DFFFF","#FF6DB6FF","#B6DBFFFF"))

cluster_color_broad = data.frame(clusterF3D_broad = c("AncientEAS","ANE","ANS","EarlyOoA","EAS","postLGM-WEurHG","preLGM-WEurHG","SA","Sahul","Satsurblia","Siberia&Americas" ,"SWA","WEur","Yamnaya"),
                                 cluster_color = 
                                   c("#009292FF","#FFCC00","#6DB6FFFF","#004949FF","#924900FF","#490092FF","#DB6D00FF","#920000FF","#006DDBFF","#FFB6DBFF","#24FF24FF","#B66DFFFF","#FF6DB6FF","#B6DBFFFF"))

cluster_color_refined = data.frame(clusterF3D_refined = c("AncientEAS","ANE","ANS","EarlyOoA","EAS","EHG","IUP","preLGM-WEurHG","SA","Sahul","Satsurblia","Siberia&Americas" ,"SWA","WEur","WHG","Yamnaya"),
                                   cluster_color = c("#009292FF","#6DB6FFFF","#004949FF","#924900FF","#DB6D00FF","#808080","#920000FF","#006DDBFF","#FFB6DBFF","#24FF24FF","#000000FF","#B66DFFFF","#FF6DB6FF","#490092FF","#B6DBFFFF","#FFCC00"))


Supercluster_color = data.frame(SuperclusterF3D = c("Americas&Asia","EarlyOoA","Sahul","WEurCAS"),Supercluster_color = c("#924900FF","#004949FF","#006DDBFF","#FF6DB6FF"))

cluster_color = cluster_color_broad

```

# Data

Most is done by Laurits Skov but here we check the ratio of the Neandertal ancestry on the X chromosome to that autosomes. Since the "Shared map" does not have any genetic distances for the X chromosome we do all X related analysis on the African-American map. We also have to take into account that 1. Not all individuals have the X chromosome covered and 2. That there is a difference in copynumber on the X conditioned on being male of female which will result into differences of Neandertal ancestry on the collapsed haploid chromosomes that we compare.


```{r eval=T,echo=F,results='hide'}
genetic_map = "AA_Map"
chrom_ <- c("1" ,"2" , "3" , "4",  "5" , "6"  ,"7" , "8" , "9" , "10" ,"11", "12" ,"13","14" ,"15", "16" ,"17" ,"18", "19" , "20" ,"21", "22", "X" )
states = c("NEA")

dir_path_EMH <- list.files(path=paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_EMH_admixfrog0.7_Shared_Map/rle/error2/length_bin_15/5000/AFR-NEA-DEN/",genetic_map,"/"),pattern = "archaicadmixtureAPX.rle0.25.xz.anno_all_types$",full.names = T)


dir_path_SGDP <- list.files(path=paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_SGDP_admixfrog0.7_Shared_Map//rle/gtmode/length_bin_15/5000/AFR-NEA-DEN/",genetic_map,"/"),pattern = "archaicadmixtureAPX.rle0.25.xz.anno_all_types$",full.names = T)


EMH_rle_all_unfiltered <- get_rle_files(directory_path = dir_path_EMH,split_char = "_",type_ = c("state"),target_ = states,chrom_ = chrom_,sep_char = ",") %>%
  drop_na() 

EMH_rle_all <- EMH_rle_all_unfiltered %>% filter(map_len >= min_len_ancient, pos_len >= min_bp_len_ancient, n_all_snps >= min_SNP)


SGDP_rle_all <- get_rle_files(directory_path = dir_path_SGDP,split_char = "_archaic",type_ = c("state"),target_ = states,chrom_ = chrom_,sep_char = ",") %>% 
  filter(map_len >= min_len_present, pos_len >= min_bp_len_present, n_all_snps >= min_SNP) %>%
  mutate(sample = gsub("-", "\\.", sample))

All_rle_annotated <- rbind(SGDP_rle_all,EMH_rle_all) %>%inner_join(.,Joint_Meta[,c("sample_name","x_chrom_captured",cluster_used,"ML_BP_Mean","time_slice","Sex")],by=c("sample"="sample_name"))
```

## Total ancestry found vs autosomes 

All calculate on the AA map and only for individuals that have the X chrom covered

```{r eval=T,echo=F,results='hide'}
callable_genome <- read.table("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/AA_callable_regions_joint_windows20000.bed",col.names = c("chrom","start","end"))  %>% mutate(len = end - start) %>% group_by(chrom) %>% dplyr::summarise(callable_bp = sum(len),callable_Mb = sum(len)/1e6) %>% mutate(chrom = ifelse(chrom == "X",23,chrom)) %>% 
  mutate_at(c('chrom'), as.numeric) 

All_rle_annotated_sum <- All_rle_annotated %>% filter(target == "NEA",x_chrom_captured == T)  %>%
  mutate(chrom =ifelse(chrom == "X",23,chrom)) %>% 
  mutate_at(c('chrom'), as.numeric) %>%
  group_by(sample,chrom,Sex,ML_BP_Mean,time_slice) %>%
  dplyr::summarize(total_NEA_ancestry_bp = sum(pos_end - pos)) %>% inner_join(.,callable_genome,by="chrom") %>% 
  mutate(Sex = ifelse(Sex == "M" ,"male",ifelse(Sex == "F","female",Sex))) %>%
  #mutate(total_NEA_ancestry_bp = ifelse(Sex == "M" | Sex == "male",total_NEA_ancestry_bp*2,total_NEA_ancestry_bp)) %>%
  mutate(percent_NEA = total_NEA_ancestry_bp/callable_bp) %>%
  mutate_at(c('chrom'), as.character) %>% mutate(chrom = ifelse(chrom == "23","X",chrom))

All_rle_annotated_sum_autosomes <- All_rle_annotated_sum %>% 
  filter(chrom != "X") %>% group_by(Sex) %>% 
  dplyr::summarize(average_NEA_bp_autosomes = mean(total_NEA_ancestry_bp), sd_NEA_bp_autosomes = sd(total_NEA_ancestry_bp), 
                   ave_prop_NEA_autosomes = mean(percent_NEA), sd_prop_NEA_autosomes = sd(percent_NEA))

All_rle_annotated_sum_X <- All_rle_annotated_sum %>% 
  filter(chrom == "X") %>% group_by(Sex) %>% 
  dplyr::summarize(average_NEA_bp_X = mean(total_NEA_ancestry_bp), sd_NEA_bp_X = sd(total_NEA_ancestry_bp), 
                   ave_prop_NEA_X = mean(percent_NEA), sd_prop_NEA_X = sd(percent_NEA))

All_rle_annotated_sum_autosomes_by_time <- All_rle_annotated_sum %>% 
  filter(chrom != "X") %>% group_by(time_slice,Sex) %>% 
  dplyr::summarize(average_NEA_bp_autosomes = mean(total_NEA_ancestry_bp), sd_NEA_bp_autosomes = sd(total_NEA_ancestry_bp), 
                   ave_prop_NEA_autosomes = mean(percent_NEA), sd_prop_NEA_autosomes = sd(percent_NEA))

All_rle_annotated_sum_X_by_time <- All_rle_annotated_sum %>% 
  filter(chrom == "X") %>% group_by(time_slice,Sex) %>% 
  dplyr::summarize(average_NEA_bp_X = mean(total_NEA_ancestry_bp), sd_NEA_bp_X = sd(total_NEA_ancestry_bp), 
                   ave_prop_NEA_X = mean(percent_NEA), sd_prop_NEA_X = sd(percent_NEA))

Amount_NEA_autosomes_X_sum <- inner_join(All_rle_annotated_sum_autosomes,All_rle_annotated_sum_X)

write.csv(All_rle_annotated_sum,paste0(folder_path_data,"All_rle_annotated_sum.csv"),quote = F,row.names = F)

## sharing all together

NEA_Overlap_data_X = All_rle_annotated %>% filter(target == "NEA",x_chrom_captured == T)   %>%
  group_overlaps_fn(.)  %>% group_by(chrom,group_id) %>% dplyr::summarize(start_pos = min(pos),end_pos = max(pos_end), n_shared = max(n)) %>% 
  mutate(pos_len = end_pos - start_pos) %>% mutate(chrom = ifelse(chrom == "X","23",chrom)) %>% 
  mutate_at(c('chrom'), as.numeric) %>% arrange(.,chrom,start_pos,end_pos)

write.table(data.frame(chrom=NEA_Overlap_data_X$chrom,start=NEA_Overlap_data_X$start_pos,end=NEA_Overlap_data_X$end_pos,name=NEA_Overlap_data_X$group_id,n_shared=NEA_Overlap_data_X$n_shared),file =paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_unmasked.bed"),quote = F,row.names = F,col.names = F,sep = '\t')

system(paste0("bedtools subtract -a ",folder_path_data,"Total_NEA_ancestry_AA_Map_X_unmasked.bed -b /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/AA_Mask_joint_windows20000.bed  > ",folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked.bed
"))

Total_NEA_ancestry_AA_Map_X_masked <- read.table(paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked.bed"),col.names = c("chrom","start","end","group_id","n_shared")) 

## sharing by sex

NEA_Overlap_data_X_female = All_rle_annotated %>% filter(target == "NEA",x_chrom_captured == T,Sex == "female")   %>%
  group_overlaps_fn(.)  %>% group_by(chrom,group_id) %>% dplyr::summarize(start_pos = min(pos),end_pos = max(pos_end), n_shared = max(n)) %>% 
  mutate(pos_len = end_pos - start_pos) %>% mutate(chrom = ifelse(chrom == "X","23",chrom)) %>% 
  mutate_at(c('chrom'), as.numeric) %>% arrange(.,chrom,start_pos,end_pos)

write.table(data.frame(chrom=NEA_Overlap_data_X_female$chrom,start=NEA_Overlap_data_X_female$start_pos,end=NEA_Overlap_data_X_female$end_pos,name=NEA_Overlap_data_X_female$group_id,n_shared=NEA_Overlap_data_X_female$n_shared),file =paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_unmasked_female.bed"),quote = F,row.names = F,col.names = F,sep = '\t')

system(paste0("bedtools subtract -a ",folder_path_data,"Total_NEA_ancestry_AA_Map_X_unmasked_female.bed -b /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/AA_Mask_joint_windows20000.bed  > ",folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked_female.bed
"))

Total_NEA_ancestry_AA_Map_X_masked_female <- read.table(paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked_female.bed"),col.names = c("chrom","start","end","group_id","n_shared")) 

NEA_Overlap_data_X_male = All_rle_annotated %>% filter(target == "NEA",x_chrom_captured == T,Sex == "male")   %>%
  group_overlaps_fn(.)  %>% group_by(chrom,group_id) %>% dplyr::summarize(start_pos = min(pos),end_pos = max(pos_end), n_shared = max(n)) %>% 
  mutate(pos_len = end_pos - start_pos) %>% mutate(chrom = ifelse(chrom == "X","23",chrom)) %>% 
  mutate_at(c('chrom'), as.numeric) %>% arrange(.,chrom,start_pos,end_pos)

write.table(data.frame(chrom=NEA_Overlap_data_X_male$chrom,start=NEA_Overlap_data_X_male$start_pos,end=NEA_Overlap_data_X_male$end_pos,name=NEA_Overlap_data_X_male$group_id,n_shared=NEA_Overlap_data_X_male$n_shared),file =paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_unmasked_male.bed"),quote = F,row.names = F,col.names = F,sep = '\t')

system(paste0("bedtools subtract -a ",folder_path_data,"Total_NEA_ancestry_AA_Map_X_unmasked_male.bed -b /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/AA_Mask_joint_windows20000.bed  > ",folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked_male.bed
"))

Total_NEA_ancestry_AA_Map_X_masked_male <- read.table(paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked_male.bed"),col.names = c("chrom","start","end","group_id","n_shared")) 

### summarize

Shared_Total_NEA_ancestry_AA_Map_autosomes_masked <- Total_NEA_ancestry_AA_Map_X_masked %>% filter(chrom != 23) %>% 
  mutate(shared = ifelse(n_shared > 1,T,F)) %>% group_by(shared) %>% 
  summarize(length_bp = sum((end - start))) %>% ungroup() %>% mutate(length_bp_percent = length_bp/ sum(length_bp))

Shared_Total_NEA_ancestry_AA_Map_X_masked <- Total_NEA_ancestry_AA_Map_X_masked %>% filter(chrom == 23) %>% 
  mutate(shared = ifelse(n_shared > 1,T,F)) %>% group_by(shared) %>% 
  summarize(length_bp = sum((end - start))) %>% ungroup() %>% mutate(length_bp_percent = length_bp/ sum(length_bp))

Shared_Total_NEA_ancestry_AA_Map_autosomes_masked_female <- Total_NEA_ancestry_AA_Map_X_masked_female %>% filter(chrom != 23) %>% 
  mutate(shared = ifelse(n_shared > 1,T,F)) %>% group_by(shared) %>% 
  summarize(length_bp = sum((end - start))) %>% ungroup() %>% mutate(length_bp_percent = length_bp/ sum(length_bp))

Shared_Total_NEA_ancestry_AA_Map_X_masked_female <- Total_NEA_ancestry_AA_Map_X_masked_female %>% filter(chrom == 23) %>% 
  mutate(shared = ifelse(n_shared > 1,T,F)) %>% group_by(shared) %>% 
  summarize(length_bp = sum((end - start))) %>% ungroup() %>% mutate(length_bp_percent = length_bp/ sum(length_bp))

Shared_Total_NEA_ancestry_AA_Map_autosomes_masked_male <- Total_NEA_ancestry_AA_Map_X_masked_male %>% filter(chrom != 23) %>% 
  mutate(shared = ifelse(n_shared > 1,T,F)) %>% group_by(shared) %>% 
  summarize(length_bp = sum((end - start))) %>% ungroup() %>% mutate(length_bp_percent = length_bp/ sum(length_bp))

Shared_Total_NEA_ancestry_AA_Map_X_masked_male <- Total_NEA_ancestry_AA_Map_X_masked_male %>% filter(chrom == 23) %>% 
  mutate(shared = ifelse(n_shared > 1,T,F)) %>% group_by(shared) %>% 
  summarize(length_bp = sum((end - start))) %>% ungroup() %>% mutate(length_bp_percent = length_bp/ sum(length_bp))

Total_NEA_ancestry_AA_Map_X_masked_sum = Total_NEA_ancestry_AA_Map_X_masked %>% mutate(seg_len = end - start) %>% group_by(chrom) %>%
  dplyr::summarise(total_NEA_ancestry_Mb = sum(seg_len)/1e6) %>% inner_join(.,callable_genome,by="chrom") %>% mutate(percent_NEA = total_NEA_ancestry_Mb/callable_Mb) %>%
  mutate_at(c('chrom'), as.character) %>% mutate(chrom = ifelse(chrom == "23","X",chrom))

autosomes_total = sum(Total_NEA_ancestry_AA_Map_X_masked_sum$total_NEA_ancestry_Mb[Total_NEA_ancestry_AA_Map_X_masked_sum$chrom != "X"])
autosomes_mean_prop = mean(Total_NEA_ancestry_AA_Map_X_masked_sum$percent_NEA[Total_NEA_ancestry_AA_Map_X_masked_sum$chrom != "X"])
X_total = Total_NEA_ancestry_AA_Map_X_masked_sum$total_NEA_ancestry_Mb[Total_NEA_ancestry_AA_Map_X_masked_sum$chrom == "X"]
X_mean_prop = Total_NEA_ancestry_AA_Map_X_masked_sum$percent_NEA[Total_NEA_ancestry_AA_Map_X_masked_sum$chrom == "X"]

Total_NEA_ancestry_AA_Map_X_masked_sum_female = Total_NEA_ancestry_AA_Map_X_masked_female %>% mutate(seg_len = end - start) %>% group_by(chrom) %>%
  dplyr::summarise(total_NEA_ancestry_Mb = sum(seg_len)/1e6) %>% inner_join(.,callable_genome,by="chrom") %>% mutate(percent_NEA = total_NEA_ancestry_Mb/callable_Mb) %>%
  mutate_at(c('chrom'), as.character) %>% mutate(chrom = ifelse(chrom == "23","X",chrom))

autosomes_total_female = sum(Total_NEA_ancestry_AA_Map_X_masked_sum_female$total_NEA_ancestry_Mb[Total_NEA_ancestry_AA_Map_X_masked_sum_female$chrom != "X"])
autosomes_mean_prop_female = mean(Total_NEA_ancestry_AA_Map_X_masked_sum_female$percent_NEA[Total_NEA_ancestry_AA_Map_X_masked_sum_female$chrom != "X"])
X_total_female = Total_NEA_ancestry_AA_Map_X_masked_sum_female$total_NEA_ancestry_Mb[Total_NEA_ancestry_AA_Map_X_masked_sum_female$chrom == "X"]
X_mean_prop_female = Total_NEA_ancestry_AA_Map_X_masked_sum_female$percent_NEA[Total_NEA_ancestry_AA_Map_X_masked_sum_female$chrom == "X"]

Total_NEA_ancestry_AA_Map_X_masked_sum_male = Total_NEA_ancestry_AA_Map_X_masked_male %>% mutate(seg_len = end - start) %>% group_by(chrom) %>%
  dplyr::summarise(total_NEA_ancestry_Mb = sum(seg_len)/1e6) %>% inner_join(.,callable_genome,by="chrom") %>% mutate(percent_NEA = total_NEA_ancestry_Mb/callable_Mb) %>%
  mutate_at(c('chrom'), as.character) %>% mutate(chrom = ifelse(chrom == "23","X",chrom))

autosomes_total_male = sum(Total_NEA_ancestry_AA_Map_X_masked_sum_male$total_NEA_ancestry_Mb[Total_NEA_ancestry_AA_Map_X_masked_sum_male$chrom != "X"])
autosomes_mean_prop_male = mean(Total_NEA_ancestry_AA_Map_X_masked_sum_male$percent_NEA[Total_NEA_ancestry_AA_Map_X_masked_sum_male$chrom != "X"])
X_total_male = Total_NEA_ancestry_AA_Map_X_masked_sum_male$total_NEA_ancestry_Mb[Total_NEA_ancestry_AA_Map_X_masked_sum_male$chrom == "X"]
X_mean_prop_male = Total_NEA_ancestry_AA_Map_X_masked_sum_male$percent_NEA[Total_NEA_ancestry_AA_Map_X_masked_sum_male$chrom == "X"]

write.csv(Total_NEA_ancestry_AA_Map_X_masked_sum,paste0(folder_path_data,"Total_NEA_ancestry_AA_Map_X_masked_sum.csv"),quote = F,row.names = F)


```

## Compare Shannon entropy between chroms

The X chromosome seems to only have a few regions with Neandertal ancestry when inspecting visually i.e. highly ordered system. To check that we calculate the Shannon entropy of the bin matrix. This matrix has individuals as columns and  0.005 cM long bins as rows. If there is a Neandertal segment it is denoted 1 ales 0. We calculate for each chromosome the Shannon entropy for all rows and take the mean.


```{r eval=F,echo=F,results='hide'}


SGDP_NEA_bins_raw = read.csv(paste("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_SGDP_admixfrog0.7_Shared_Map/stats/gtmode/length_bin_15/5000/AFR-NEA-DEN/AA_Map/All_bins_NEA_PresentDaySGDP_archaicadmixtureAPX.bin_called",penalty,"_min_len",min_len_present,"_min_len_pos",min_bp_len_present,"_min_n_all_SNP",min_SNP,"_min_n_SNP",min_all_SNP,".xz",sep=""))


sample_list_ancient = Joint_Meta %>% filter(ML_BP_Mean > 0) %>% 
  filter(SuperclusterF3D != "Africa") %>% .$sample_name

EMH_NEA_bins_raw = read.csv(paste("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_EMH_admixfrog0.7_Shared_Map/stats/error2/length_bin_15/5000/AFR-NEA-DEN/AA_Map/All_bins_NEA_CurratedEMHPublished_archaicadmixtureAPX.bin_called",penalty,"_min_len",min_len_ancient,"_min_len_pos",min_bp_len_ancient,"_min_n_all_SNP",min_SNP,"_min_n_SNP",min_all_SNP,".xz",sep=""))  %>% dplyr::select(chrom,map,!!sample_list_ancient)
ALL_NEA_bins_raw = inner_join(SGDP_NEA_bins_raw,EMH_NEA_bins_raw,by=c("chrom","map")) 


ALL_NEA_bins_raw <- ALL_NEA_bins_raw[,c(1:4)] %>% group_by(chrom) %>% mutate(pos_end = lead(pos)) %>% ungroup() %>% 
  mutate(pos_end = ifelse(is.na(pos_end), pos + 5000,pos_end)) %>% mutate(pos_len = pos_end - pos) %>% cbind(.,ALL_NEA_bins_raw[,c(5:length(ALL_NEA_bins_raw))])

non_callable_bins <- read.csv(paste0("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/bin_ref/AA_Map/archaicadmixtureAPX_admixfrog_bins_ref_non_callable_bins.csv"),col.names = c("chrom","map","pos","id"))

ALL_NEA_bins_raw_masked <- anti_join(ALL_NEA_bins_raw,non_callable_bins,by="id")

ALL_NEA_bins_raw_matrix <- ALL_NEA_bins_raw_masked[,c(7:length(ALL_NEA_bins_raw_masked))]

ALL_NEA_bins_raw_matrix[ALL_NEA_bins_raw_matrix > 0] <- 1

ALL_NEA_bins_raw_masked <- cbind(ALL_NEA_bins_raw_masked[,c(1:6)],ALL_NEA_bins_raw_matrix) %>% dplyr::select(!c(pos_end,pos_len))

sample_list_X <- Joint_Meta %>% filter(x_chrom_captured == T) %>% .$sample_name

ALL_NEA_bins_raw_masked_red <- ALL_NEA_bins_raw_masked %>% dplyr::select(chrom,map,pos,id,!!sample_list_X)

sample_list_X_present <- Joint_Meta %>% filter(x_chrom_captured == T,ML_BP_Mean == 0) %>% .$sample_name

Mean_NEA_bins_raw_masked_red_AA_map_present <- ALL_NEA_bins_raw_masked %>% dplyr::select(!!sample_list_X_present) %>% rowMeans(.)

sample_list_X_ancient <- Joint_Meta %>% filter(x_chrom_captured == T,ML_BP_Mean > 1) %>% .$sample_name

Mean_NEA_bins_raw_masked_red_AA_map_ancient <- ALL_NEA_bins_raw_masked %>% dplyr::select(!!sample_list_X_ancient) %>% rowMeans(.)

Mean_NEA_bins_raw_masked_red_AA_map <- data.frame(chrom = ALL_NEA_bins_raw_masked_red$chrom,
                                                  map = ALL_NEA_bins_raw_masked_red$map,
                                                  pos = ALL_NEA_bins_raw_masked_red$pos,
                                                  id = ALL_NEA_bins_raw_masked_red$id,
                                                  mean_PD =Mean_NEA_bins_raw_masked_red_AA_map_present,
                                                  mean_ancient = Mean_NEA_bins_raw_masked_red_AA_map_ancient)

write.csv(Mean_NEA_bins_raw_masked_red_AA_map,"~/EMH_Introgression_Project/Introgression_Detection/Supplements_Tables/PP_date_bins_AA_map.csv",quote = F,row.names = F)

```


```{r eval=F,echo=F,results='hide'}
library(foreach)
library(doParallel)

# Function to calculate entropy
calculate_entropy <- function(values) {
  # Count the occurrences of each unique value in the matrix
  counts <- table(values)
  
  # Calculate probabilities
  probabilities <- prop.table(counts)
  
  # Calculate entropy
  entropy <- -sum(probabilities * log2(probabilities))
  
  return(entropy)
}

num_cores <- 25
cl <- makeCluster(num_cores)
registerDoParallel(cl)


# Parallelized loop
Joint_Entropy_per_chroms <- foreach(i = unique(ALL_NEA_bins_raw_masked_red$chrom), .combine='rbind') %dopar% {
  print(paste0("computing entropy fro chrom: ",i))
  chrom_x <- ALL_NEA_bins_raw_masked_red[ALL_NEA_bins_raw_masked_red$chrom == i,]
  chrom_x_matrix <- as.matrix(chrom_x[,c(5:length(chrom_x))])
  entropy_all_chrom_x_matrix <- apply(chrom_x_matrix, 1, calculate_entropy)
  entropy_all_chrom_x_mean <- mean(entropy_all_chrom_x_matrix,na.rm = T)
  data.frame(chrom = rep(i,length(entropy_all_chrom_x_matrix)), entropy =entropy_all_chrom_x_matrix, bin_id = chrom_x$id)
}

# Convert the result to a matrix
Joint_Entropy_per_chroms <- as.matrix(Joint_Entropy_per_chroms)

# Stop the parallel backend
stopCluster(cl)

write.csv(Joint_Entropy_per_chroms,"~/EMH_Introgression_Project/Introgression_Detection/Supplements_Tables/Mean_Shannon_entropy_over_rows_of_bin_matrix_per_chrom.csv",quote = F,row.names = F)


```


```{r eval=F,echo=F,results='hide'}

num_cores <- 25
cl <- makeCluster(num_cores)
registerDoParallel(cl)


# Parallelized loop
Joint_Entropy_per_chroms_red <- foreach(i = unique(ALL_NEA_bins_raw_masked_red$chrom), .combine='rbind') %dopar% {
  print(paste0("computing entropy fro chrom: ",i))
  chrom_x <- ALL_NEA_bins_raw_masked_red[ALL_NEA_bins_raw_masked_red$chrom == i,]
  chrom_x_matrix <- as.matrix(chrom_x[,c(5:length(chrom_x))])
  chrom_x_matrix_red <- chrom_x_matrix[rowSums(chrom_x_matrix^2)>0,]
  entropy_all_chrom_x_matrix <- apply(chrom_x_matrix_red, 1, calculate_entropy)
  entropy_all_chrom_x_mean <- mean(entropy_all_chrom_x_matrix,na.rm = T)
  data.frame(chrom = rep(i,length(entropy_all_chrom_x_matrix)), entropy =entropy_all_chrom_x_matrix, bin_id = seq(1,length(entropy_all_chrom_x_matrix)))
}

# Convert the result to a matrix
Joint_Entropy_per_chroms_red <- as.matrix(Joint_Entropy_per_chroms_red)

# Stop the parallel backend
stopCluster(cl)

write.csv(Joint_Entropy_per_chroms_red,"~/EMH_Introgression_Project/Introgression_Detection/Supplements_Tables/Mean_Shannon_entropy_over_rows_of_bin_matrix_per_chrom_non_zero_ancestry_only.csv",quote = F,row.names = F)

```

```{r eval=T,echo=F,results='hide'}

Chrom_entropy_all <- read.csv("~/EMH_Introgression_Project/Introgression_Detection/Supplements_Tables/Mean_Shannon_entropy_over_rows_of_bin_matrix_per_chrom.csv")

mean_per_autosome <- Chrom_entropy_all %>% filter(chrom != "X") %>% group_by(chrom) %>% summarize(mean_H = mean(entropy))

mean_entropy_autosomes_all <- mean(Chrom_entropy_all$entropy[Chrom_entropy_all$chrom != "X"])
  
entropy_X_all <- mean(Chrom_entropy_all$entropy[Chrom_entropy_all$chrom == "X"])

wilcox_test_result_all <- wilcox.test(x = Chrom_entropy_all$entropy[Chrom_entropy_all$chrom == "X"], y=Chrom_entropy_all$entropy[Chrom_entropy_all$chrom != "X"], alternative = "less")

wilcox_test_result_all_on_mean <- wilcox.test(x = entropy_X_all, y = mean_per_autosome$mean_H,alternative = "less")


Chrom_entropy_red <- read.csv("~/EMH_Introgression_Project/Introgression_Detection/Supplements_Tables/Mean_Shannon_entropy_over_rows_of_bin_matrix_per_chrom_non_zero_ancestry_only.csv")

mean_per_autosome_red <- Chrom_entropy_red %>% filter(chrom != "X") %>% group_by(chrom) %>% summarize(mean_H = mean(entropy))

mean_entropy_autosomes_red <- mean(Chrom_entropy_red$entropy[Chrom_entropy_red$chrom != "X"])
  
entropy_X_red <- mean(Chrom_entropy_red$entropy[Chrom_entropy_red$chrom == "X"])

wilcox_test_result_red <- wilcox.test(x = Chrom_entropy_red$entropy[Chrom_entropy_red$chrom == "X"], y=Chrom_entropy_red$entropy[Chrom_entropy_red$chrom != "X"], alternative = "less")


```

### calculate median frequency for non zero ancestry bins between autosomes and X


```{r eval=T,echo=F,results='hide'}
x <- ALL_NEA_bins_raw_masked[ALL_NEA_bins_raw_masked$chrom != "X",]
x <- as.matrix(x[,c(5:length(x))])
freq_x <- rowMeans(x)
Autosomes_median_freq <- median(freq_x[freq_x > 0])

x <- ALL_NEA_bins_raw_masked[ALL_NEA_bins_raw_masked$chrom == "X",]
x <- as.matrix(x[,c(5:length(x))])
freq_x <- rowMeans(x)
X_median_freq <- median(freq_x[freq_x > 0])
```

## X to autosome  ratios

```{r eval=T,echo=F,results='hide'}
Sum_autosomes <- All_rle_annotated %>% filter(x_chrom_captured == TRUE,chrom != "X") %>% 
  group_by(sample,!!sym(cluster_used),Sex,ML_BP_Mean,time_slice,chrom) %>% 
  dplyr::summarize(sum_length_bp_autosomes = sum(pos_len),sum_length_cM_autosomes = sum(map_len)) %>% 
  ungroup() %>% group_by(sample,!!sym(cluster_used),ML_BP_Mean,time_slice,Sex) %>% 
  dplyr::summarize(mean_length_bp_autosomes = mean(sum_length_bp_autosomes),mean_length_cM_autosomes = mean(sum_length_cM_autosomes)) %>%
  ungroup()

Sum_X <- All_rle_annotated %>% filter(x_chrom_captured == TRUE,chrom == "X") %>% 
  group_by(sample,!!sym(cluster_used),ML_BP_Mean,time_slice,Sex) %>% 
  dplyr::summarize(total_length_bp_X = sum(pos_len),total_length_cM_X = sum(map_len)) %>% ungroup()

X_to_autosome_ratio <- inner_join(Sum_autosomes,Sum_X) %>% mutate(ratio_bp = total_length_bp_X / mean_length_bp_autosomes ,
                                                                  ratio_cM = total_length_cM_X / mean_length_cM_autosomes)

write.csv(x = X_to_autosome_ratio,file = paste0(folder_path_data,"X_to_autosome_ratio.csv"),quote = F,row.names = F)


# per callable bp

callable_genome <- read.table("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/AA_callable_regions_joint_windows20000.bed",col.names = c("chrom","start","end"))  %>% mutate(len = end - start) %>% group_by(chrom) %>% dplyr::summarise(callable = sum(len)) %>% mutate(chrom = ifelse(chrom == 23,"X",chrom)) 


Sum_autosomes_pre_bp <- All_rle_annotated %>% filter(x_chrom_captured == TRUE,chrom != "X") %>% 
  group_by(sample,!!sym(cluster_used),Sex,ML_BP_Mean,time_slice,chrom) %>% 
  dplyr::summarize(Total_sum_NEA_autosomes = sum(pos_len)) %>% 
  ungroup() %>% inner_join(.,callable_genome) %>% group_by(sample,!!sym(cluster_used),Sex,ML_BP_Mean,time_slice) %>% 
  dplyr::summarize(NEA_autosomes_pre_bp = sum(Total_sum_NEA_autosomes) / sum(callable), Total_sum_NEA_autosomes = sum(Total_sum_NEA_autosomes))

Sum_X_pre_bp <- All_rle_annotated %>% filter(x_chrom_captured == TRUE,chrom == "X") %>% 
  group_by(sample,!!sym(cluster_used),Sex,ML_BP_Mean,time_slice,chrom) %>% 
  dplyr::summarize(Total_sum_NEA_chrX = sum(pos_len)) %>% 
  ungroup() %>% inner_join(.,callable_genome) %>% mutate(NEA_chrX_pre_bp = Total_sum_NEA_chrX / callable)

X_to_autosome_ratio_pre_bp <- inner_join(Sum_autosomes_pre_bp,Sum_X_pre_bp) %>% mutate(ratio_prop_bp = NEA_chrX_pre_bp / NEA_autosomes_pre_bp)

write.csv(x = X_to_autosome_ratio_pre_bp,file = paste0(folder_path_data,"X_to_autosome_ratio_pre_bp.csv"),quote = F,row.names = F)

```

## NEA freq on X vs. recomb rate


Using normal cutoffs

```{r eval=T,echo=F,results='hide'}
dir_path_EMH <- list.files(path=paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_EMH_admixfrog0.7_Shared_Map/rle/error2/length_bin_15/5000/AFR-NEA-DEN/AA_Map/"),pattern = "rle0.25.xz.anno_all_types$",full.names = T)


dir_path_SGDP <- list.files(path=paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_SGDP_admixfrog0.7_Shared_Map//rle/gtmode/length_bin_15/5000/AFR-NEA-DEN/AA_Map/"),pattern = "rle0.25.xz.anno_all_types$",full.names = T)


EMH_file_names_NEA_state = write_bed_from_rle(directory_path = dir_path_EMH,split_char = "_",type_ = c("state"),target_ = c("NEA"),chrom_ = c("X"),path = paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_EMH_admixfrog0.7_Shared_Map/rle/error2/length_bin_15/5000/AFR-NEA-DEN/AA_Map/X/"),min_len = 0.2,min_bp_len = 0,min_SNP = 0)

SGDP_file_names_NEA_state = write_bed_from_rle(directory_path = dir_path_SGDP,split_char = "_archaic",type_ = c("state"),target_ = c("NEA"),chrom_ = c("X"),path = paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_SGDP_admixfrog0.7_Shared_Map/rle/gtmode/length_bin_15/5000/AFR-NEA-DEN/AA_Map/X/"),min_len = 0.05,min_bp_len = 0,min_SNP = 0)


system(paste0("bedtools multiinter -i ",paste(c(EMH_file_names_NEA_state,SGDP_file_names_NEA_state), collapse=' ',sep = " ")," >  ",folder_path_data,"All_NEA_state_with_indcount_unmasked_matrix_AA_Map_X_chrom.bed"))


n_inds = Joint_Meta %>% filter(x_chrom_captured == T) %>% nrow()
window_sizes = c(20000,50000,100000,200000,500000,1000000)

for(window_size in window_sizes){
  print(paste0("Calculatinf window size: ",window_size))
  
  sample_names <- read.table(paste0(folder_path_data,"All_Archaic_state_with_indcount_unmasked_matrix_sample_names.txt"))[,1]
  All_inds = gsub(x = sample_names,pattern = "-",replacement = ".")
  Ancient_inds = Joint_Meta %>% filter(ML_BP_Mean > 0)  %>% .$sample_name
  Present_Day_inds = Joint_Meta %>% mutate(sample_name = gsub(x = sample_name,pattern = "-",replacement = ".")) %>%
    filter(ML_BP_Mean == 0)  %>% .$sample_name
  
  chrom_limits = read_csv("~/EMH_Introgression_Project/Introgression_Detection/ref/chrom_limits.csv") 
  
  chrom_ = "1"
  chrom_limits_x = chrom_limits %>% filter(chrom == chrom_)
  AA_mask <- data.frame(chrom = chrom_,pos=seq(from = chrom_limits_x$pos0_min,to = chrom_limits_x$pos_max,by = window_size))  
  AA_mask <- AA_mask %>% mutate(pos_end = ifelse(is.na(dplyr::lead(pos)),pos+window_size,dplyr::lead(pos)))
  
  chrom_ <- c("2" , "3" , "4",  "5" , "6"  ,"7" , "8" , "9" , "10" ,"11", "12" ,"13","14" ,"15", "16" ,"17" ,"18", "19" , "20" ,"21", "22" , "X" )
  for(chr in chrom_){
    chrom_limits_x = chrom_limits %>% filter(chrom == chr)
    AA_mask_x <- data.frame(chrom = chr,pos=seq(from = chrom_limits_x$pos0_min,to = chrom_limits_x$pos_max,by = window_size))
    AA_mask_x <- AA_mask_x %>% mutate(pos_end = ifelse(is.na(dplyr::lead(pos)),pos+window_size,dplyr::lead(pos)))
    AA_mask <- rbind(AA_mask,AA_mask_x)
  }
    
  
  
  write.table(AA_mask,paste("~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/Genome_in_windows",window_size,"bp.bed",sep=""),quote = F,row.names = F,col.names = F,sep = "\t")
  
  system(paste0("bedtools intersect -a ~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/Genome_in_windows",window_size,"bp.bed -b ~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/archaicadmixtureAPX.bed -c -f 1E-9 > /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/ArchaicAdmixtureAPX_sample_dens_windows",window_size,".txt"))
  
  
  coverage_masker = read.table(paste0("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/ArchaicAdmixtureAPX_sample_dens_windows",window_size,".txt"),col.names = c("chrom","start","end","n_SNP")) %>% 
    filter(chrom == "X", n_SNP > 0) %>% mutate(chrom = ifelse(chrom == "X",23,chrom))
  
  write.table(x = coverage_masker[,c("chrom","start","end")],file = paste0("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/X_chromosome_in_windows",window_size,"bp.bed"),
              row.names = F,quote = F,col.names = F,sep = "\t")
  
  system(paste0("bedtools intersect -b ",folder_path_data,"All_NEA_state_with_indcount_unmasked_matrix_AA_Map_X_chrom.bed -a /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/X_chromosome_in_windows",window_size,"bp.bed -wo > ",folder_path_data,"All_NEA_state_with_indcount_AA_Map_X_callable_intersect_matrix_annotated_",window_size,"bp_windows.bed"))
  
  Nea_ancestry_20kb_X <- read.table(paste0(folder_path_data,"All_NEA_state_with_indcount_AA_Map_X_callable_intersect_matrix_annotated_",window_size,"bp_windows.bed"),col.names = c("chrom","start","end","chromB","startB","endB","n_ind","col_ind",All_inds,"Overlap")) 
  
  
  interpolated_starts <- c()
  interpolated_ends <- c()
  for (chr in unique(Nea_ancestry_20kb_X$chrom)) {
    print(chr)
    
    positions_to_interpolate = Nea_ancestry_20kb_X %>% filter(chrom == chr)
    chr = ifelse(chr == 23,"X",chr)
    map_x <- read.table(paste0("~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/maps_b37/maps_chr.",chr),header = T) %>%
      mutate(pos_len = lead(Physical_Pos) - Physical_Pos, map_len = lead(AA_Map) - AA_Map) %>% drop_na() %>% mutate(map_rate = map_len / pos_len)
    
    # Interpolate genetic distances for the current chromosome
    interpolated_start <- as.data.frame(approx(map_x$Physical_Pos, map_x$AA_Map, 
                                               xout = positions_to_interpolate$start))
    
    interpolated_end <- as.data.frame(approx(map_x$Physical_Pos, map_x$AA_Map, 
                                             xout = positions_to_interpolate$end))
    
    
    interpolated_starts <- c(interpolated_starts,interpolated_start$y)
    interpolated_ends <- c(interpolated_ends,interpolated_end$y)
  }

  Nea_ancestry_20kb_X <- Nea_ancestry_20kb_X %>% mutate(map_start = interpolated_starts,
                                                        map_end = interpolated_ends) %>%
    mutate(rec_rate = (map_end - map_start) / window_size)
  
  
  Autosomes_chrom_all_inds = Joint_Meta %>% filter(SuperclusterF3D != "Africa",x_chrom_captured == T)  %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_All <- Nea_ancestry_20kb_X %>% 
    dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(Autosomes_chrom_all_inds),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(Autosomes_chrom_all_inds) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>% 
    mutate(Nea_freq = (n_ind / length(Autosomes_chrom_all_inds))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "All Data")
  
  
  T_0 = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 0,x_chrom_captured == T) %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name 
  
  Nea_ancestry_X_20kb_stat_T_0 <- Nea_ancestry_20kb_X %>% 
    dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_0),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_0) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
    mutate(Nea_freq = (n_ind / length(T_0))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "Present Day")
  
  T_1 = Joint_Meta %>% filter(SuperclusterF3D != "Africa",time_slice == 1,x_chrom_captured == T) %>% mutate(sample_name = gsub(x =sample_name,pattern = "\\.",replacement = "-")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_1 <- Nea_ancestry_20kb_X %>% 
      dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_1),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_1) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
      mutate(Nea_freq = (n_ind / length(T_1))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "1 - 10000")
  
  T_2 = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 10000,x_chrom_captured == T) %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_2 <- Nea_ancestry_20kb_X %>% 
      dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_2),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_2) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
      mutate(Nea_freq = (n_ind / length(T_2))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate))  %>% mutate(time = "10000 - 30000")
  
  T_3 = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 30000,SuperclusterF3D != "EarlyOoA") %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_3 <- Nea_ancestry_20kb_X %>% 
    dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_3),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_3) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
    mutate(Nea_freq = (n_ind / length(T_3))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = ">30000")
  
    T_EarlyOoA = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 30000,SuperclusterF3D == "EarlyOoA") %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_EarlyOoA <- Nea_ancestry_20kb_X %>% 
      dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_EarlyOoA),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_EarlyOoA) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
      mutate(Nea_freq = (n_ind / length(T_EarlyOoA))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "EarlyOoA")
  
  Nea_ancestry_X_20kb_stat_by_time_slices <- rbind(Nea_ancestry_X_20kb_stat_All,Nea_ancestry_X_20kb_stat_T_0,Nea_ancestry_X_20kb_stat_T_1,Nea_ancestry_X_20kb_stat_T_2,Nea_ancestry_X_20kb_stat_T_3,
                                                 Nea_ancestry_X_20kb_stat_T_EarlyOoA) %>% ungroup()
  
  Nea_ancestry_X_20kb_stat_by_time_slices$time <- factor(Nea_ancestry_X_20kb_stat_by_time_slices$time,levels=c("EarlyOoA",">30000", "10000 - 30000", "1 - 10000", "Present Day","All Data"))
  

  write.csv(Nea_ancestry_X_20kb_stat_by_time_slices,file = paste0(folder_path_data,"Nea_ancestry_X_chrom_",window_size,"bp_stat_by_time_slices.csv"),quote = F,row.names = F)
  

}

Nea_ancestry_X_chrom_20kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_20000bp_stat_by_time_slices.csv")) %>% mutate(window_size = 20000)
Nea_ancestry_X_chrom_50kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_50000bp_stat_by_time_slices.csv")) %>% mutate(window_size = 50000) 
Nea_ancestry_X_chrom_100kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_1e+05bp_stat_by_time_slices.csv")) %>% mutate(window_size = 100000) 
Nea_ancestry_X_chrom_200kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_2e+05bp_stat_by_time_slices.csv")) %>% mutate(window_size = 200000) 
Nea_ancestry_X_chrom_500kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_5e+05bp_stat_by_time_slices.csv")) %>% mutate(window_size = 500000) 
Nea_ancestry_X_chrom_1Mb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_1e+06bp_stat_by_time_slices.csv")) %>% mutate(window_size = 1000000) 

Nea_ancestry_X_chrom_stat_by_time_slices <- rbind(Nea_ancestry_X_chrom_20kb_stat_by_time_slices,Nea_ancestry_X_chrom_50kb_stat_by_time_slices,
                                          Nea_ancestry_X_chrom_100kb_stat_by_time_slices,Nea_ancestry_X_chrom_200kb_stat_by_time_slices,
                                          Nea_ancestry_X_chrom_500kb_stat_by_time_slices,Nea_ancestry_X_chrom_1Mb_stat_by_time_slices) %>% 
  filter(time == "All Data")

t = 1
res_x <- list()
for(i in 1:length(unique(Nea_ancestry_X_chrom_stat_by_time_slices$time))){
  for(j in 1:length(unique(Nea_ancestry_X_chrom_stat_by_time_slices$window_size))){
    x = Nea_ancestry_X_chrom_stat_by_time_slices %>% filter(time == unique(Nea_ancestry_X_chrom_stat_by_time_slices$time)[i],window_size == unique(Nea_ancestry_X_chrom_stat_by_time_slices$window_size)[j])
    cor_x =  cor.test(x=x$rec_rate, y=x$ave_alpha, method = 'spearman') 
    res_x[[t]] = data.frame(time = unique(Nea_ancestry_X_chrom_stat_by_time_slices$time)[i],window_size = unique(Nea_ancestry_X_chrom_stat_by_time_slices$window_size)[j],
                            rho = cor_x$estimate, p_value = cor_x$p.value)
    t = t + 1
  }
  
}
res_rec_rate_vs_Nea_freq_X_chrom_cor <- do.call("rbind",res_x)

write.csv(res_rec_rate_vs_Nea_freq_X_chrom_cor,file = paste0(folder_path_Sup_Tables,"Recomb_cor_all_inds_X_chrom.csv"),quote = F,row.names = F)

```

Using 0.01 cM for all

```{r eval=T,echo=F,results='hide'}
dir_path_EMH <- list.files(path=paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_EMH_admixfrog0.7_Shared_Map/rle/error2/length_bin_15/5000/AFR-NEA-DEN/AA_Map/"),pattern = "rle0.25.xz.anno_all_types$",full.names = T)


dir_path_SGDP <- list.files(path=paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_SGDP_admixfrog0.7_Shared_Map//rle/gtmode/length_bin_15/5000/AFR-NEA-DEN/AA_Map/"),pattern = "rle0.25.xz.anno_all_types$",full.names = T)


EMH_file_names_NEA_state = write_bed_from_rle(directory_path = dir_path_EMH,split_char = "_",type_ = c("state"),target_ = c("NEA"),chrom_ = c("X"),path = paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_EMH_admixfrog0.7_Shared_Map/rle/error2/length_bin_15/5000/AFR-NEA-DEN/AA_Map/X/"),min_len = 0.01,min_bp_len = 0,min_SNP = 0)

SGDP_file_names_NEA_state = write_bed_from_rle(directory_path = dir_path_SGDP,split_char = "_archaic",type_ = c("state"),target_ = c("NEA"),chrom_ = c("X"),path = paste0("/mnt/diversity/leonardo_iasi/EMH_Introgression_Project/New_REF_AA_with_APX_SGDP_admixfrog0.7_Shared_Map/rle/gtmode/length_bin_15/5000/AFR-NEA-DEN/AA_Map/X/"),min_len = 0.01,min_bp_len = 0,min_SNP = 0)


system(paste0("bedtools multiinter -i ",paste(c(EMH_file_names_NEA_state,SGDP_file_names_NEA_state), collapse=' ',sep = " ")," >  ",folder_path_data,"All_NEA_state_with_indcount_unmasked_matrix_AA_Map_X_chrom_lower_cutoff.bed"))


n_inds = Joint_Meta %>% filter(x_chrom_captured == T) %>% nrow()
window_sizes = c(20000,50000,100000,200000,500000,1000000)

for(window_size in window_sizes){
  print(paste0("Calculatinf window size: ",window_size))
  
  sample_names <- read.table(paste0(folder_path_data,"All_Archaic_state_with_indcount_unmasked_matrix_sample_names.txt"))[,1]
  All_inds = gsub(x = sample_names,pattern = "-",replacement = ".")
  Ancient_inds = Joint_Meta %>% filter(ML_BP_Mean > 0)  %>% .$sample_name
  Present_Day_inds = Joint_Meta %>% mutate(sample_name = gsub(x = sample_name,pattern = "-",replacement = ".")) %>%
    filter(ML_BP_Mean == 0)  %>% .$sample_name
  
  chrom_limits = read_csv("~/EMH_Introgression_Project/Introgression_Detection/ref/chrom_limits.csv") 
  
  chrom_ = "1"
  chrom_limits_x = chrom_limits %>% filter(chrom == chrom_)
  AA_mask <- data.frame(chrom = chrom_,pos=seq(from = chrom_limits_x$pos0_min,to = chrom_limits_x$pos_max,by = window_size))  
  AA_mask <- AA_mask %>% mutate(pos_end = ifelse(is.na(dplyr::lead(pos)),pos+window_size,dplyr::lead(pos)))
  
  chrom_ <- c("2" , "3" , "4",  "5" , "6"  ,"7" , "8" , "9" , "10" ,"11", "12" ,"13","14" ,"15", "16" ,"17" ,"18", "19" , "20" ,"21", "22" , "X" )
  for(chr in chrom_){
    chrom_limits_x = chrom_limits %>% filter(chrom == chr)
    AA_mask_x <- data.frame(chrom = chr,pos=seq(from = chrom_limits_x$pos0_min,to = chrom_limits_x$pos_max,by = window_size))
    AA_mask_x <- AA_mask_x %>% mutate(pos_end = ifelse(is.na(dplyr::lead(pos)),pos+window_size,dplyr::lead(pos)))
    AA_mask <- rbind(AA_mask,AA_mask_x)
  }
    
  
  
  write.table(AA_mask,paste("~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/Genome_in_windows",window_size,"bp.bed",sep=""),quote = F,row.names = F,col.names = F,sep = "\t")
  
  system(paste0("bedtools intersect -a ~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/Genome_in_windows",window_size,"bp.bed -b ~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/archaicadmixtureAPX.bed -c -f 1E-9 > /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/ArchaicAdmixtureAPX_sample_dens_windows",window_size,".txt"))
  
  
  coverage_masker = read.table(paste0("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/ref/published/EMHPanel/Shared_Map/Masks/ArchaicAdmixtureAPX_sample_dens_windows",window_size,".txt"),col.names = c("chrom","start","end","n_SNP")) %>% 
    filter(chrom == "X", n_SNP > 0) %>% mutate(chrom = ifelse(chrom == "X",23,chrom))
  
  write.table(x = coverage_masker[,c("chrom","start","end")],file = paste0("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/X_chromosome_in_windows",window_size,"bp.bed"),
              row.names = F,quote = F,col.names = F,sep = "\t")
  
  system(paste0("bedtools intersect -b ",folder_path_data,"All_NEA_state_with_indcount_unmasked_matrix_AA_Map_X_chrom_lower_cutoff.bed -a /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/bed/X_chromosome_in_windows",window_size,"bp.bed -wo > ",folder_path_data,"All_NEA_state_with_indcount_AA_Map_X_callable_intersect_matrix_annotated_lower_cutoff",window_size,"bp_windows.bed"))
  
  Nea_ancestry_20kb_X <- read.table(paste0(folder_path_data,"All_NEA_state_with_indcount_AA_Map_X_callable_intersect_matrix_annotated_lower_cutoff",window_size,"bp_windows.bed"),col.names = c("chrom","start","end","chromB","startB","endB","n_ind","col_ind",All_inds,"Overlap")) 
  
  
  interpolated_starts <- c()
  interpolated_ends <- c()
  for (chr in unique(Nea_ancestry_20kb_X$chrom)) {
    print(chr)
    
    positions_to_interpolate = Nea_ancestry_20kb_X %>% filter(chrom == chr)
    chr = ifelse(chr == 23,"X",chr)
    map_x <- read.table(paste0("~/EMH_Introgression_Project/Introgression_Detection/admixfrogREF/maps_b37/maps_chr.",chr),header = T) %>%
      mutate(pos_len = lead(Physical_Pos) - Physical_Pos, map_len = lead(AA_Map) - AA_Map) %>% drop_na() %>% mutate(map_rate = map_len / pos_len)
    
    # Interpolate genetic distances for the current chromosome
    interpolated_start <- as.data.frame(approx(map_x$Physical_Pos, map_x$AA_Map, 
                                               xout = positions_to_interpolate$start))
    
    interpolated_end <- as.data.frame(approx(map_x$Physical_Pos, map_x$AA_Map, 
                                             xout = positions_to_interpolate$end))
    
    
    interpolated_starts <- c(interpolated_starts,interpolated_start$y)
    interpolated_ends <- c(interpolated_ends,interpolated_end$y)
  }

  Nea_ancestry_20kb_X <- Nea_ancestry_20kb_X %>% mutate(map_start = interpolated_starts,
                                                        map_end = interpolated_ends) %>%
    mutate(rec_rate = (map_end - map_start) / window_size)
  
  
  Autosomes_chrom_all_inds = Joint_Meta %>% filter(SuperclusterF3D != "Africa",x_chrom_captured == T)  %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_All <- Nea_ancestry_20kb_X %>% 
    dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(Autosomes_chrom_all_inds),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(Autosomes_chrom_all_inds) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>% 
    mutate(Nea_freq = (n_ind / length(Autosomes_chrom_all_inds))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "All Data")
  
  
  T_0 = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 0,x_chrom_captured == T) %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name 
  
  Nea_ancestry_X_20kb_stat_T_0 <- Nea_ancestry_20kb_X %>% 
    dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_0),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_0) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
    mutate(Nea_freq = (n_ind / length(T_0))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "Present Day")
  
  T_1 = Joint_Meta %>% filter(SuperclusterF3D != "Africa",time_slice == 1,x_chrom_captured == T) %>% mutate(sample_name = gsub(x =sample_name,pattern = "\\.",replacement = "-")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_1 <- Nea_ancestry_20kb_X %>% 
      dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_1),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_1) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
      mutate(Nea_freq = (n_ind / length(T_1))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "1 - 10000")
  
  T_2 = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 10000,x_chrom_captured == T) %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_2 <- Nea_ancestry_20kb_X %>% 
      dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_2),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_2) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
      mutate(Nea_freq = (n_ind / length(T_2))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate))  %>% mutate(time = "10000 - 30000")
  
  T_3 = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 30000,SuperclusterF3D != "EarlyOoA") %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_3 <- Nea_ancestry_20kb_X %>% 
    dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_3),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_3) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
    mutate(Nea_freq = (n_ind / length(T_3))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = ">30000")
  
    T_EarlyOoA = Joint_Meta  %>% filter(SuperclusterF3D != "Africa",time_slice == 30000,SuperclusterF3D == "EarlyOoA") %>% mutate(sample_name = gsub(x =sample_name,pattern = "-",replacement = ".")) %>% .$sample_name
  
  Nea_ancestry_X_20kb_stat_T_EarlyOoA <- Nea_ancestry_20kb_X %>% 
      dplyr::select(chrom,start,end,chromB,startB,endB,n_ind,col_ind,!!c(T_EarlyOoA),Overlap,map_start,map_end,rec_rate) %>%
    mutate(n_ind  = rowSums(.[9:(9 + length(T_EarlyOoA) - 1)])) %>%
    dplyr::select(chrom,start,end,n_ind,Overlap,map_start,map_end,rec_rate) %>%
      mutate(Nea_freq = (n_ind / length(T_EarlyOoA))) %>% 
    group_by(chrom,start,end) %>%
    summarize(ave_alpha = sum((Nea_freq * Overlap)) / window_size,Nea_freq = mean(Nea_freq),rec_rate = mean(rec_rate)) %>% mutate(time = "EarlyOoA")
  
  Nea_ancestry_X_20kb_stat_by_time_slices <- rbind(Nea_ancestry_X_20kb_stat_All,Nea_ancestry_X_20kb_stat_T_0,Nea_ancestry_X_20kb_stat_T_1,Nea_ancestry_X_20kb_stat_T_2,Nea_ancestry_X_20kb_stat_T_3,
                                                 Nea_ancestry_X_20kb_stat_T_EarlyOoA) %>% ungroup()
  
  Nea_ancestry_X_20kb_stat_by_time_slices$time <- factor(Nea_ancestry_X_20kb_stat_by_time_slices$time,levels=c("EarlyOoA",">30000", "10000 - 30000", "1 - 10000", "Present Day","All Data"))
  

  write.csv(Nea_ancestry_X_20kb_stat_by_time_slices,file = paste0(folder_path_data,"Nea_ancestry_X_chrom_",window_size,"bp_stat_by_time_slices.csv"),quote = F,row.names = F)
  

}

Nea_ancestry_X_chrom_20kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_20000bp_stat_by_time_slices.csv")) %>% mutate(window_size = 20000)
Nea_ancestry_X_chrom_50kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_50000bp_stat_by_time_slices.csv")) %>% mutate(window_size = 50000) 
Nea_ancestry_X_chrom_100kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_1e+05bp_stat_by_time_slices.csv")) %>% mutate(window_size = 100000) 
Nea_ancestry_X_chrom_200kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_2e+05bp_stat_by_time_slices.csv")) %>% mutate(window_size = 200000) 
Nea_ancestry_X_chrom_500kb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_5e+05bp_stat_by_time_slices.csv")) %>% mutate(window_size = 500000) 
Nea_ancestry_X_chrom_1Mb_stat_by_time_slices <- read.csv(paste0(folder_path_data,"Nea_ancestry_X_chrom_1e+06bp_stat_by_time_slices.csv")) %>% mutate(window_size = 1000000) 

Nea_ancestry_X_chrom_stat_by_time_slices <- rbind(Nea_ancestry_X_chrom_20kb_stat_by_time_slices,Nea_ancestry_X_chrom_50kb_stat_by_time_slices,
                                          Nea_ancestry_X_chrom_100kb_stat_by_time_slices,Nea_ancestry_X_chrom_200kb_stat_by_time_slices,
                                          Nea_ancestry_X_chrom_500kb_stat_by_time_slices,Nea_ancestry_X_chrom_1Mb_stat_by_time_slices) %>% 
  filter(time == "All Data")

t = 1
res_x <- list()
for(i in 1:length(unique(Nea_ancestry_X_chrom_stat_by_time_slices$time))){
  for(j in 1:length(unique(Nea_ancestry_X_chrom_stat_by_time_slices$window_size))){
    x = Nea_ancestry_X_chrom_stat_by_time_slices %>% filter(time == unique(Nea_ancestry_X_chrom_stat_by_time_slices$time)[i],window_size == unique(Nea_ancestry_X_chrom_stat_by_time_slices$window_size)[j])
    cor_x =  cor.test(x=x$rec_rate, y=x$ave_alpha, method = 'spearman') 
    res_x[[t]] = data.frame(time = unique(Nea_ancestry_X_chrom_stat_by_time_slices$time)[i],window_size = unique(Nea_ancestry_X_chrom_stat_by_time_slices$window_size)[j],
                            rho = cor_x$estimate, p_value = cor_x$p.value)
    t = t + 1
  }
  
}
res_rec_rate_vs_Nea_freq_X_chrom_cor_min_001 <- do.call("rbind",res_x)

write.csv(res_rec_rate_vs_Nea_freq_X_chrom_cor_min_001,file = paste0(folder_path_Sup_Tables,"Recomb_cor_all_inds_X_chrom_lower_cutoff.csv"),quote = F,row.names = F)

```


## Neandertal frequency on X vs B stat

```{r eval=T,echo=F,results='hide'}
n_inds = Joint_Meta %>% filter(x_chrom_captured == T,SuperclusterF3D != "Africa") %>% nrow()

sample_names <- read.table(paste0(folder_path_data,"All_Archaic_state_with_indcount_unmasked_matrix_sample_names.txt"))[,1] 

sample_names <- sample_names[sample_names %in% gsub(pattern = "\\.",replacement = "-",Joint_Meta$sample_name[Joint_Meta$x_chrom_captured == T ])]


system(paste0("bedtools intersect -a ",folder_path_data,"All_NEA_state_with_indcount_unmasked_matrix_AA_Map_X_chrom.bed -b /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/B_Stat/bstat_hg19_with_X_alt.txt -wo > /home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/B_Stat/All_NEA_state_with_indcount_callable_intersect_matrix_annotated_Bstat_X_chrom.bed"))

Nea_ancestry_ind_count_reducedSGDP_Bstat <- read.table("/home/leonardo_iasi/EMH_Introgression_Project/Introgression_Detection/B_Stat/All_NEA_state_with_indcount_callable_intersect_matrix_annotated_Bstat_X_chrom.bed") %>% mutate(Nea_freq = (V4 / n_inds))
Nea_ancestry_ind_count_reducedSGDP_Bstat$Bstat <- Nea_ancestry_ind_count_reducedSGDP_Bstat$V343
Nea_ancestry_ind_count_reducedSGDP_Bstat$OverlapBstat <- Nea_ancestry_ind_count_reducedSGDP_Bstat$V344


Nea_ancestry_ind_count_reducedSGDP_Bstat <- Nea_ancestry_ind_count_reducedSGDP_Bstat %>% 
  mutate(Bstat_bin = cut(Bstat, breaks = c(-1,200, 400, 600, 800, 1000), right = T, labels = F)) %>% group_by(Bstat_bin) %>% 
    summarize(ave_alpha = sum(Nea_freq * OverlapBstat)/ sum(OverlapBstat))

write.csv(Nea_ancestry_ind_count_reducedSGDP_Bstat,file = paste0(folder_path_data,"B_stat_on_X_chrom.csv"),quote = F,row.names = F)


```
